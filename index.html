<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<title>Gerador de Certificado - Amigo da Vila Calderita</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<style>
		
	</style>
</head>
<body>
	<h1>Certificado de Amigo(a) da Vila Calderita</h1>
	<label for="nome">Nome Completo:</label>
	<input type="text" id="nome" name="nome">
	
	<label for="data">Data da Emissão:</label>
	<input type="date" id="data" name="data">
	
	<button onclick="gerarCertificado()">Emitir Certificado</button>
	
<script>
	function formatarDataParaPdf(dataString) {
		const dataObj = new Date(dataString + 'T00:00:00');
		const dia = dataObj.getDate();
		const mesIndex = dataObj.getMonth();
		const ano = dataObj.getFullYear();
		const diaFormatado = String(dia).padStart(2, '0');
		const mesesPt = [
			"janeiro", "fevereiro", "março", "abril", "maio", "junho","julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
		];
		
		const nomeMes = mesesPt[mesIndex];
		return `${diaFormatado} de ${nomeMes} de ${ano}`;
	}

	function gerarCertificado() {
		const nomeCompleto = document.getElementById('nome').value;
		const dataSelecionada = document.getElementById('data').value;
		
		if (!nomeCompleto || !dataSelecionada) {
			alert("Por favor, preencha o nome e a data.");
			return;
		}
		
		// INÍCIO DA NOVA LÓGICA DE CARREGAMENTO
		// Tarefa 1: carregar imagem de fundo
		const promessaDaImagem = new Promise((resolve,reject) => {
			console.log("Iniciando carregamento da imagem de fundo...");
			const imagem = new Image();
			imagem.crossOrigin = "anonymous"; // Permite carregar imagens de outros domínios, se necessário
			imagem.onload = () => {
				console.log("Imagem de fundo carregada.");
				resolve(imagem);
			};
			imagem.onerror = () => reject(new Error ("Não foi possível carregar a imagem 'certificado.png'"));
			imagem.src = "certificado.png";
		});

		//Tarefa 2: Carregar o arquivo da fonte
		const promessaDaFonte = new Promise((resolve,reject) => {
			console.log("Iniciando carregamento da fonte...");
			//fetch busca o arquivo da fonte no seu repositório

			fetch('Fontes/NOMEDAFONTE.ttf')
				.then(responde => response.arrayBuffer()) // Pega os dados brutos da fonte
				.then(data => {
					console.log("Fonte carregada.");
					//converte os dados para um formato que a jsPDF entende (base64)
					const base64 = btoa (String.fromCharCode.apply(null,new Uint8Array(data)));
					resolve(base64);
				})
				.catch(error => reject (new Error("Não foi possível carregar a fonte 'NOMEDAFONTE.ttf'")));
		});
					
		//Promise.all vai esperar as duas tarefas (imagem e fonte) terminarem
		Promise.all([promessaDaImagem, promessaDaFonte])
			.then(([imagemCarregada, fonteCarregadaEmBase64]) => {
				//SUCESSO! Ambos os arquivos foram carregados. Agora geramos o PDF.
				console.log("Imagem e fonte carregadas! Gerando o PDF...");
				
				const canvas = document.createElement('canvas');
				canvas.width = imagemCarregada.naturalWidth;
				canvas.height = imagemCarregada.naturalHeight;
				const ctx = canvas.getContext('2d');
				ctx.drawImage(imagemCarregada, 0, 0);
				const imageDataUrl = canvas.toDataURL('image/png');
				const { jsPDF } = window.jspdf;
				const doc = new jsPDF({ orientation: 'landscape' });
				
				//Registrando a nova fonte na jsPDF
				const nomeDoArquivoDaFonte = 'NOMEDAFONTE.ttf';
				const nomeDaFonteNoCodigo = 'NOMEDAFONTE'; //nome que usaremos para chamar a fonte
				doc.addFileToVFS(nomeDoArquivoDaFonte, fonteCarregadaEmBase64);
				doc.addFont(nomeDoArquivoDaFonte, nomeDaFonteNoCodigo, 'normal');
				console.log("Fonte 'NOMEDAFONTE' registrada na jsPDF.")

				const larguraPagina = doc.internal.pageSize.getWidth();
				const alturaPagina = doc.internal.pageSize.getHeight();

				doc.addImage(imageDataURL, 'PNG', 0, 0, larguraPagina, alturaPagina);

				const dataFormatada = formatarDataParaPDF(dataSelecionada);

				//Agora você pode usar doc.setFont ('NOMEDAFONTE') para trocar a fonte

				doc.setFontSize(14); //Tamanho padrão
				doc.setFont('NOMEDAFONTE', 'normal'); //Fonte padrão para o início
				
				let yPos = 20; //ajuste do Y inicial
				const lineHeight = 8;
				const paragraphSpacing = 4;
				
				doc.text("A comunidade da", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight;
				doc.text("Vila da Calderita", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight + paragraphSpacing;

				doc.setFont('NOMEDAFONTE'); // Alterar fonte
				doc.setFontSize(32); // Ajustar tamanho da fonte
				doc.text("representada por sua Associação dos Moradores e Amigos da Vila Calderita (AMAVICA),", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight;
				doc.text("confere o título de:", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight + paragraphSpacing;
				doc.setFontSize(14);
				doc.text("Amigo(a) da Calderita", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight;
				doc.setFontSize(12);
				doc.text("a(o) Senhor(a) " + nomeCompleto, larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight + paragraphSpacing;
				doc.text("por seu reconhecido mérito em sua atuação participativa na Comunidade", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight;
				doc.text("em seus serviços voluntários relevantes.", larguraPagina / 2, yPos, {align:'center'});
				yPos += lineHeight + paragraphSpacing * 2;
				doc.text("Porto Velho, " + dataFormatada + ".", larguraPagina -15, yPos, {align:'right'});
				
				//espaço vertical antes das assinaturas
				const yPosAssinaturas = alturaPagina -25;
				
				//linha de assinatura
				const signatureLineText = "_________________________________________";
				
				// fonte 10 para as assinaturas
				doc.setFontSize(10); 
				
				//assinatura Nazira (metade esquerda)
				let yNazira = yPosAssinaturas;
				doc.text(signatureLineText, larguraPagina / 4, yNazira, {align:'center'});
				yNazira += 4; // desce uma linha
				doc.text("Maria Nazira Freitas de Sá", larguraPagina / 4, yNazira, {align:'center'});
				yNazira += 4; // desce uma linha
				doc.text("Presidente", larguraPagina / 4, yNazira,{align:'center'});
				
				//assinatura anselmo (metade direita)
				let yAnselmo = yPosAssinaturas; //volta para a altura inicial para alinhar horizontalmente
				doc.text(signatureLineText, (3 * larguraPagina) / 4, yAnselmo, {align:'center'});
				yAnselmo += 4; //desce uma linha
				doc.text("Anselmo Duarte", (3* larguraPagina) / 4, yAnselmo, {align:'center'});
				yAnselmo += 4; //desce uma linha
				doc.text("Vice-Presidente", (3* larguraPagina) / 4, yAnselmo, {align:'center'});
				
				// A linha abaixo que pega o nomeCompleto ainda é necessária para o nome do arquivo
				// const nomeCompleto = document.getElementById('nome').value; // Já está no início da função gerarCertificado
				doc.save("Certificado_VilaCalderita_" + nomeCompleto.replace(/ /g, "_") + ".pdf");
				console.log("Função gerarCertificado concluída, PDF salvo (com teste de centralização).");
			}
			.catch(error => {
				//Se qualquer uma das tarefas falhar (imagem ou fonte), mostrará este erro.
				console.error("Erro ao carregar recursos:", error);
				alert("Houve um erro ao carregar imagem de fundo ou a fonte. Verifique o console (f12) para detalhes.");
			});
		}
</script>
	
</body>
</html>
