<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerador de Certificado - Amigo da Vila Calderita</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
       
    </style>
</head>
<body>

    <h1>Certificado de Amigo(a) da Vila Calderita</h1>

    <label for="nome">Nome Completo:</label>
    <input type="text" id="nome" name="nome">

    <label for="data">Data da Emissão:</label>
    <input type="date" id="data" name="data">

    <button onclick="gerarCertificado()">Emitir Certificado</button>

    <script>
        function formatarDataParaPdf(dataString) {
            const dataObj = new Date(dataString + 'T00:00:00');
            const dia = dataObj.getDate();
            const mesIndex = dataObj.getMonth();
            const ano = dataObj.getFullYear();
            const diaFormatado = String(dia).padStart(2, '0');
            const mesesPt = [
                "janeiro", "fevereiro", "março", "abril", "maio", "junho",
                "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
            ];
            const nomeMes = mesesPt[mesIndex];
            return `${diaFormatado} de ${nomeMes} de ${ano}`;
        }

        function gerarCertificado() {
            const nomeCompleto = document.getElementById('nome').value;
            const dataSelecionada = document.getElementById('data').value;

            if (!nomeCompleto || !dataSelecionada) {
                alert("Por favor, preencha o nome e a data.");
                return;
            }

            // DIAGNÓSTICO: Verificando se estamos tentando carregar a imagem
            console.log("Tentando carregar a imagem de fundo: certificado.png");

            const imagemPlanoDeFundo = new Image();
            imagemPlanoDeFundo.crossOrigin = "anonymous"; // Permite carregar imagens de outros domínios, se necessário
            
            // IMPORTANTE: Defina os manipuladores de evento ANTES de definir o .src
            imagemPlanoDeFundo.onload = function() {
                // DIAGNÓSTICO: Imagem carregada com sucesso!
                console.log("imagemPlanoDeFundo.onload FOI ACIONADO!");
                console.log("Dimensões naturais da imagem: ", this.naturalWidth, "x", this.naturalHeight);

                if (this.naturalWidth === 0 || this.naturalHeight === 0) {
                    console.error("ERRO: A imagem foi carregada, mas as dimensões são zero. O arquivo de imagem pode estar corrompido ou vazio.");
                    alert("A imagem de fundo parece estar vazia ou corrompida, apesar de ter sido carregada.");
                    return; // Não continuar se a imagem não tiver dimensões
                }

                const canvas = document.createElement('canvas');
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(this, 0, 0);

                let imageDataUrl;
                try {
                    imageDataUrl = canvas.toDataURL('image/png');
                    // DIAGNÓSTICO: Data URL gerada. Verifique se parece válida.
                    console.log("imageDataUrl gerada (início): ", imageDataUrl.substring(0, 100) + "..."); // Mostra só o começo
                    if (imageDataUrl.length < 100) { // Um DataURL válido de uma imagem PNG será bem maior
                        console.error("ERRO: imageDataUrl parece muito curta para ser válida!");
                        alert("Houve um problema ao converter a imagem de fundo.");
                        return;
                    }
                } catch (e) {
                    console.error("Erro ao gerar DataURL: ", e);
                    alert("Erro ao processar a imagem de fundo: " + e.message);
                    return;
                }

                const dataFormatada = formatarDataParaPdf(dataSelecionada);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });

                const larguraPagina = doc.internal.pageSize.getWidth();
                const alturaPagina = doc.internal.pageSize.getHeight();

                // DIAGNÓSTICO: Antes de adicionar a imagem ao PDF
                console.log("Adicionando imagem ao PDF. Largura da página:", larguraPagina, "Altura:", alturaPagina);

                try {
                    doc.addImage(imageDataUrl, 'PNG', 0, 0, larguraPagina, alturaPagina);
                    // DIAGNÓSTICO: Depois de adicionar a imagem ao PDF
                    console.log("Imagem teoricamente adicionada ao PDF.");
                } catch (e) {
                    console.error("ERRO ao executar doc.addImage:", e);
                    alert("Erro da biblioteca jsPDF ao tentar adicionar a imagem: " + e.message);
                    return;
                }


                // ADICIONAR TODO O TEXTO DO CERTIFICADO SOBRE A IMAGEM
                let yPos = 20;
                const xPos = 20;
                const lineHeight = 8;
                const paragraphSpacing = 4;
                doc.setFontSize(12);
                doc.text("A comunidade da", xPos, yPos);
                yPos += lineHeight;
                doc.text("Vila da Calderita", xPos, yPos);
                yPos += lineHeight + paragraphSpacing;
                doc.text("representada por sua Associação dos Moradores e Amigos da Vila Calderita (AMAVICA),", xPos, yPos);
                yPos += lineHeight;
                doc.text("confere o título de:", xPos, yPos);
                yPos += lineHeight + paragraphSpacing;
                doc.setFontSize(14);
                doc.text("Amigo(a) da Calderita", xPos, yPos);
                yPos += lineHeight;
                doc.setFontSize(12);
                doc.text("a(o) Senhor(a) " + nomeCompleto, xPos, yPos);
                yPos += lineHeight + paragraphSpacing;
                doc.text("por seu reconhecido mérito em sua atuação participativa na Comunidade", xPos, yPos);
                yPos += lineHeight;
                doc.text("em seus serviços voluntários relevantes.", xPos, yPos);
                yPos += lineHeight + paragraphSpacing * 2;
                doc.text("Porto Velho, " + dataFormatada + ".", xPos, yPos);
                yPos += lineHeight * 3.5;
                const signatureLine = "_________________________________________";
                doc.text(signatureLine, xPos, yPos);
                yPos += lineHeight;
                doc.text("Maria Nazira Freitas de Sá (Presidente)", xPos, yPos);
                yPos += lineHeight * 2;
                doc.text(signatureLine, xPos, yPos);
                yPos += lineHeight;
                doc.text("Anselmo Duarte (Vice-Presidente)", xPos, yPos);

                doc.save("Certificado_VilaCalderita_" + nomeCompleto.replace(/ /g, "_") + ".pdf");
                // DIAGNÓSTICO: PDF salvo.
                console.log("Função gerarCertificado concluída, PDF salvo.");

            }; // Fim do imagemPlanoDeFundo.onload

            imagemPlanoDeFundo.onerror = function() {
                // DIAGNÓSTICO: Erro ao carregar a imagem!
                console.error("imagemPlanoDeFundo.onerror FOI ACIONADO!");
                alert("ERRO CRÍTICO: Não foi possível carregar a imagem de fundo 'certificado.png'. Verifique se o nome do arquivo está correto, se ele está na MESMA PASTA que o arquivo index.html e se não está corrompido.");
            };

            // IMPORTANTE: .src deve ser definido DEPOIS dos manipuladores .onload e .onerror
            imagemPlanoDeFundo.src = "certificado.png";

        }
    </script>

</body>
</html>